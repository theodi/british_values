upstream open-data-certificate {
  server 127.0.0.1:3000;
}

server {
  listen 80 default;
  server_name certificates.theodi.org;
  access_log /var/log/nginx/certificates.theodi.org.log;
  error_log /var/log/nginx/certificates.theodi.org.err;
  root /var/www/certificates.theodi.org/current/public/;

  location / {
    try_files $uri @backend;
  }

  location ~ ^/(assets)/ {
      add_header Access-Control-Allow-Origin "*";
    gzip_static on; # to serve pre-gzipped version
    expires max;
    add_header Cache-Control public;
  }

  location @backend {
    proxy_set_header X-Forwarded-Proto 'http';
    proxy_set_header Host $server_name;
    proxy_pass http://open-data-certificate;
  }
}

server {
  server_name certificate.theodi.org;
  listen 80;
  rewrite ^/(.*)$ http://certificates.theodi.org/$1 permanent;
}
